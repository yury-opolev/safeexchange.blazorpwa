@using Microsoft.AspNetCore.Components.WebAssembly.Authentication;
@using SafeExchange.Client.Web.Components.Model;

@inject NotificationsSubscriber subscriber
<!-- Modal -->
<div class="modal fade" id="settingsDialog" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLabel">Settings</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="mx-2">
                    <EditForm Model="@this.SubState">
                        <div>Notifications:</div>
                        <div class="my-2 mx-4">
                            <InputRadioGroup @bind-Value="this.SubState" disabled="@this.IsInProgress">
                                <InputRadio Value="SubscriptionState.Subscribed" /> Enabled
                                <br>
                                <InputRadio Value="SubscriptionState.NotSubscribed" /> Disabled
                            </InputRadioGroup>
                        </div>
                    </EditForm>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@code {

    private SubscriptionState subState;

    private SubscriptionState SubState
    {
        get => this.subState;

        set
        {
            if (value == this.subState)
            {
                return;
            }

            _ = this.OnSubscriptionChangeAsync(value);
        }
    }

    private bool IsInProgress { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var isSubscribed = await subscriber.IsSubscribed();
        this.subState = isSubscribed ? SubscriptionState.Subscribed : SubscriptionState.NotSubscribed;
        this.IsInProgress = false;
    }

    private async Task OnSubscriptionChangeAsync(SubscriptionState updatedState)
    {
        if (updatedState == SubscriptionState.Subscribed)
        {
            updatedState = await this.SubscribeAsync();
        }
        else
        {
            updatedState = await this.UnsubscribeAsync();
        }

        this.subState = updatedState;
    }

    private async Task<SubscriptionState> SubscribeAsync()
    {
        this.IsInProgress = true;
        try
        {
            var subscription = await subscriber.Subscribe();
            return SubscriptionState.Subscribed;
        }
        catch (AccessTokenNotAvailableException ex)
        {
            ex.Redirect();
            return SubscriptionState.NotSubscribed;
        }
        catch (Exception)
        {
            return SubscriptionState.NotSubscribed;
        }
        finally
        {
            this.IsInProgress = false;
        }
    }

    private async Task<SubscriptionState> UnsubscribeAsync()
    {
        this.IsInProgress = true;
        try
        {
            await subscriber.Unsubscribe();
            return SubscriptionState.NotSubscribed;
        }
        catch (AccessTokenNotAvailableException ex)
        {
            ex.Redirect();
            return SubscriptionState.Subscribed;
        }
        catch (Exception)
        {
            return SubscriptionState.Subscribed;
        }
        finally
        {
            this.IsInProgress = false;
        }
    }
}
